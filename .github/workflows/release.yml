name: Build and Release

permissions:
    contents: write

on:
    push:
        branches: ["main"]
        tags: ["v*"]
    pull_request:
        branches: ["main"]

env:
    BINARY_NAME: edbgserver

jobs:
    build:
        name: Build ${{ matrix.target }}
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                include:
                    - target: x86_64-unknown-linux-musl
                      arch: x86_64
                      musl_cc: x86_64-linux-musl-cross
                    - target: aarch64-unknown-linux-musl
                      arch: aarch64
                      musl_cc: aarch64-linux-musl-cross

        steps:
            # 1. Checkout source code
            - name: Checkout repository
              uses: actions/checkout@v4

            # 2. Install Rust Nightly with rust-src
            # This is required for compiling the eBPF component
            - name: Install Rust Nightly
              uses: dtolnay/rust-toolchain@nightly
              with:
                  components: rust-src

            # 3. Install Rust Stable
            - name: Install Rust Stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            # 4. Install LLVM
            # Required for bpf-linker and compiling eBPF
            - name: Install LLVM
              run: sudo apt-get update && sudo apt-get install -y llvm clang

            # 5. Install Musl Cross Toolchain
            # Replaces cargo-zigbuild. Downloads the compiler specified in your config.
            - name: Install Musl Toolchain
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  gh release download toolchains -p "${{ matrix.musl_cc }}.tgz" --repo ${{ github.repository }}
                  mv ${{ matrix.musl_cc }}.tgz toolchain.tgz
                  tar -xf toolchain.tgz
                  echo "$(pwd)/${{ matrix.musl_cc }}/bin" >> $GITHUB_PATH

            - name: Verify Toolchain
              run: |
                  if [[ "${{ matrix.arch }}" == "aarch64" ]]; then
                    aarch64-linux-musl-gcc --version
                  else
                    x86_64-linux-musl-gcc --version
                  fi

            # 6. Cache Cargo dependencies
            - name: Cache Cargo tools
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            # 7. Install bpf-linker
            - name: Install bpf-linker
              run: |
                  if ! command -v bpf-linker &> /dev/null; then
                    cargo install bpf-linker
                  fi

            # 8. Build the project
            - name: Build Binary
              run: cargo build --release --target ${{ matrix.target }}

            # 9. Prepare artifact
            - name: Rename and Move Binary
              run: |
                  mkdir -p dist
                  cp target/${{ matrix.target }}/release/${{ env.BINARY_NAME }} dist/${{ env.BINARY_NAME }}-${{ matrix.arch }}

            # 10. Upload Artifact to GitHub Actions Summary
            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.BINARY_NAME }}-${{ matrix.arch }}
                  path: dist/${{ env.BINARY_NAME }}-${{ matrix.arch }}

    release:
        name: Create Release
        needs: build
        if: startsWith(github.ref, 'refs/tags/v')
        runs-on: ubuntu-latest
        steps:
            - name: Download Artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts
                  merge-multiple: true

            - name: List Artifacts
              run: ls -R artifacts

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: artifacts/*
                  generate_release_notes: true
